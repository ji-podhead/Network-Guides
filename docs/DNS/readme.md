# DNS
> we will install our dns on Debian
> - its a stable distro for networking
> - its my proxmox-machine so i thought it would make sense not to outsource my dns and dhcp, since i use the proxmox machine for my networking and virtualisation stuff anyway.
> 
## Preperation
- ***on the machine that runs the dns:***
  - get the ips of the NIC`s
```Bash
- ip a
```
>```
>...
>2: enp1s0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast master vmbr0 state UP group default qlen 1000
>    link/ether 52:54:00:56:9e:57 brd ff:ff:ff:ff:ff:ff
>3: enp9s0: <BROADCAST,MULTICAST> mtu 1500 qdisc noop state DOWN group default qlen 1000
>    link/ether 74:d0:2b:9d:49:43 brd ff:ff:ff:ff:ff:ff
>4: vmbr0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default qlen 1000
>    link/ether 52:54:00:56:9e:57 brd ff:ff:ff:ff:ff:ff
>    inet 192.168.122.7/24 scope global vmbr0
>       valid_lft forever preferred_lft forever
>    inet6 fe80::5054:ff:fe56:9e57/64 scope link 
>       valid_lft forever preferred_lft forever
>```
> in my case the ip of the DNS-machine is `192.168.122.7` since it's using the `vmbr0 Network Bridge`  for virtualisation

---

- ***on the host:***
  - check out the resolv.conf and add the ip of the nameserver that we will just create.
>```
>############################################################################################################
>#                                        /etc/resolv.conf 
>#############################################################################################################
> # Generated by NetworkManager
>search speedport.ip
>nameserver 192.168.122.7                   #    <----- THE IP OF OUR DNS
>nameserver 2a02:3032:317:1192::92
>nameserver 192.168.2.1
>nameserver 192.168.61.86
># NOTE: the libc resolver may not support more than 3 nameservers.
># The nameservers listed below may not be recognized.
>nameserver fe80::1%enp2s0
>```
> this file will be constantly get resetted by NetworkManager, so we will need to add our Ip again later, but i wanted to explain this before we start the actual DNS-installation 


 
  ## Install Bind9
  ```Bash
  #  sudo apt-get install bind9 bind9utils bind9-doc
  ```
  - enable it:
  
  ```Bash
# systemctl enable bind9
# sudo systemctl enable named
```

## configure your DNS

> in our case we want to resolve  foreman.de to the ip `xxx` 
- edit the `named.conf.options` file
  
>```
>############################################################################################################
>#                                        /etc/bind/named.conf.options
>#############################################################################################################
>
>acl local-lan {
>  localhost;
>  192.168.1.0/24;
>  192.168.122.0/24; # Netzwork for vmbr0
>  192.168.123.0/24; # additional Networks 
>};
>options {
>  directory "/var/cache/bind";
>  forwarders {
>192.168.61.86;    # the DNS my phone uses
>192.168.2.1;      # the DNS of my NIC 
>  };
>  allow-query { local-lan; }; # Erlaubt Anfragen nur von den in local-lan definierten Netzwerken
>  dnssec-validation auto;
>  auth-nxdomain no;    // conform to RFC1035
>  listen-on-v6 { any; };
>  recursion no;  // we set that to no to avoid unnecessary traffic
>  querylog yes; // Enable for debugging
>  version "not available"; // Disable for security
>};
>```

---

- edit `nano /etc/bind/named.conf.local`
>```
>############################################################################################################
>#                                        /etc/bind/named.conf.local
>#############################################################################################################
>
>//include "/etc/bind/zones.rfc1918";
>zone "foreman.de" IN {
>        type master;
>        file "/etc/bind/zones/foreman.de";
>         allow-query { any; };  
>#       allow-update { any; };
>};
>zone "0.116.10.in-addr.arpa" IN {
>        type master;
>        file "/etc/bind/zones/foreman.de.rev";
>         allow-query { any; };
> #       allow-update { any; };
>};
>```

---

- create the foreward and backward files:
```Bash
 # cp /etc/bind/db.local /etc/bind/zones/foreman.de
 # cp /etc/bind/db.127 /etc/bind/zones/foreman.de.rev
```

--- 

- edit `/etc/bind/zones/foreman.de`:
>```
>############################################################################################################
>#                                        /etc/bind/zones/foreman.de
>#############################################################################################################                                                                                         
>;
>; BIND data file for local loopback interface
>;
>$TTL    604800
>@       IN      SOA     foreman.de. root.foreman.de. (
>                              2         ; Serial
>                         604800         ; Refresh
>                          86400         ; Retry
>                        2419200         ; Expire
>                         604800 )       ; Negative Cache TTL
>;
>@       IN      NS      bindserver.foreman.de.
>; A record for name server
>bindserver      IN      A       192.168.122.20
>@       IN      NS      localhost.
>@       IN      A       192.168.122.20
>@       IN      AAAA    ::1
>```



---

- edit `/etc/bind/zones/foreman.de.rev`

>```
>############################################################################################################
>#                                        /etc/bind/zones/foreman.de.rev
>#############################################################################################################                                                                                         
>;
>; BIND reverse data file for local loopback interface
>;
>$TTL    604800
>@       IN      SOA     foreman.de. root.foreman.de. (
>                              1         ; Serial
>                         604800         ; Refresh
>                          86400         ; Retry
>                        2419200         ; Expire
>                         604800 )       ; Negative Cache TTL
>;
>; Name server record
>@       IN      NS     bindserver.foreman.de.
>; A record for name server
>bindserver      IN      A      192.168.122.20
>20.122.168.192.in-addr.arpa. IN PTR foreman.de.
>@       IN      NS      localhost.
>1.0.0   IN      PTR     localhost.
>```

---

## Update Bind9

```Bash
# named-checkzone foreman.de /etc/bind/zones/foreman.de
# named-checkzone foreman.de /etc/bind/zones/foreman.de.rev
# named-checkconf /etc/bind/named.conf.options
# named-checkconf
# sudo systemctl restart bind9
```
---

## Test & Debug
- we have several options here:
> ***DNS-Host:***
> - journalctl, syslogs, cache
> ***DNS-Client:***
> - wget, dig, telnet, tcdump

### DNS-Client 


***wget:***

```Bash
#  wget foreman.de
```

> this doesnt show us which dns is currently used, but it show us the Domain that the DNS resolved for us 

>```
>--2024-06-07 16:12:23--  http://foreman.de/
>Auflösen des Hostnamens foreman.de (foreman.de)… ::1, 192.168.122.20
>Verbindungsaufbau zu foreman.de (foreman.de)|::1|:80 … fehlgeschlagen: Verbindungsaufbau abgelehnt.
>Verbindungsaufbau zu foreman.de (foreman.de)|192.168.122.20|:80 … verbunden.
>HTTP-Anforderung gesendet, auf Antwort wird gewartet … 301 Moved Permanently
>Platz: https://foreman.de/ [folgend]
>--2024-06-07 16:12:23--  https://foreman.de/
>Verbindungsaufbau zu foreman.de (foreman.de)|192.168.122.20|:443 … verbunden.
>FEHLER: Dem Zertifikat von »foreman.de« wird nicht vertraut.
>FEHLER: Das Zertifikat von »»foreman.de«« hat keinen bekannten Austeller.
>```

---

***dig:***
```Bash
 # dig foreman.de
```
> this also tells us which DNS resolved our IP
>```
>[ji@base Dokumente]$ dig foreman.de
>
>; <<>> DiG 9.16.23-RH <<>> foreman.de
>;; global options: +cmd
>;; Got answer:
>;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 39704
>;; flags: qr aa rd; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1
>;; WARNING: recursion requested but not available
>
>;; OPT PSEUDOSECTION:
>; EDNS: version: 0, flags:; udp: 1232
>; COOKIE: 42f88eb9501cc520010000006663162e7378e4c0f794bcaf (good)
>;; QUESTION SECTION:
>;foreman.de.			IN	A
>
>;; ANSWER SECTION:
>foreman.de.		604800	IN	A	192.168.122.20
>
>;; Query time: 0 msec
>;; SERVER: 192.168.122.7#53(192.168.122.7)
>;; WHEN: Fri Jun 07 16:16:14 CEST 2024
>;; MSG SIZE  rcvd: 83
>```
> so just figured out that our DNS is `192.168.122.7` and that he found our IP in A

---

***dump the tcp-logs for port 53:***
```Bash
sudo tcpdump udp port 53 --interface virbr0 -vv
```
> - we use `virbr0` since its the network bridge the machine of our DNS-host requries, since its also running proxmox
> - is use my mobile phone here to access the internet, so the other DNS that's inside my resolv.conf will be ignored
- a successfull query will look like this:
>```
>dropped privs to tcpdump
>tcpdump: listening on virbr0, link-type EN10MB (Ethernet), snapshot length 262144 bytes
>...
>    192.168.122.7.domain > my-proxmox.de.33723: [bad udp cksum 0x75ab -> 0xf568!] 60350*- q: AAAA? foreman.de. 1/0/0 foreman.de. AAAA ::1 (56)
>16:04:48.840074 IP (tos 0x0, ttl 64, id 23172, offset 0, flags [DF], proto UDP (17), length 56)
>    my-proxmox.de.50724 > 192.168.122.7.domain: [bad udp cksum 0x758f -> 0x26fa!] 63196+ A? foreman.de. (28)
>16:04:48.840088 IP (tos 0x0, ttl 64, id 23173, offset 0, flags [DF], proto UDP (17), length 56)
>    my-proxmox.de.50724 > 192.168.122.7.domain: [bad udp cksum 0x758f -> 0xc8e3!] 21720+ AAAA? foreman.de. (28)
>16:04:48.840507 IP (tos 0x0, ttl 64, id 31967, offset 0, flags [none], proto UDP (17), length 72)
>    192.168.122.7.domain > my-proxmox.de.50724: [bad udp cksum 0x759f -> 0x6d7f!] 63196*- q: A? foreman.de. 1/0/0 foreman.de. A 192.168.122.20 (44)
>16:04:48.840569 IP (tos 0x0, ttl 64, id 31968, offset 0, flags [none], proto UDP (17), length 84)
>```

---
